<!DOCTYPE html>
<html lang="en">
<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title> Component Visualization</title>
		<script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
<div class="h-screen flex flex-col lg:flex-row bg-gray-900">
	<div class="lg:w-1/3 p-4 flex flex-col h-full border-r border-gray-700">
		<h2 class="text-2xl font-bold mb-4 text-green-400">Component Exploration Tool</h2>
		<div class="flex-1 overflow-auto">
			<h3 class="text-xl font-semibold mb-2 text-blue-400">Node Controls</h3>
			<button class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2 w-full mb-2 text-gray-300 border-gray-500">
				Focus Node
			</button>
			<div class="mb-2">
				<h4 class="text-lg font-semibold mb-2 text-yellow-500">Filter Nodes</h4>
				<button
					type="button"
					role="combobox"
					aria-controls="radix-:R4sulllla:"
					aria-expanded="false"
					aria-autocomplete="none"
					dir="ltr"
					data-state="closed"
					data-placeholder=""
					class="flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
				>
					<span style="pointer-events:none">Select nodes</span>
					<svg
						xmlns="http://www.w3.org/2000/svg"
						width="24"
						height="24"
						viewBox="0 0 24 24"
						fill="none"
						stroke="currentColor"
						stroke-width="2"
						stroke-linecap="round"
						stroke-linejoin="round"
						class="h-4 w-4 opacity-50"
						aria-hidden="true"
					>
						<path d="m6 9 6 6 6-6"></path>
					</svg>
				</button>
			</div>
			<h3 class="text-xl font-semibold mb-2 text-blue-400">Roots</h3>
			<div class="mb-2">
				<button
					id="toggle-roots-list"
					type="button"
					role="combobox"
					aria-controls="radix-:R3culllla:"
					aria-expanded="false"
					aria-autocomplete="none"
					dir="ltr"
					data-state="closed"
					data-placeholder=""
					class="text-gray-300 flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
					onclick="toggleOptionsList()"
				>
					<span style="pointer-events:none">Select a root</span>
					<svg
						xmlns="http://www.w3.org/2000/svg"
						width="24"
						height="24"
						viewBox="0 0 24 24"
						fill="none"
						stroke="currentColor"
						stroke-width="2"
						stroke-linecap="round"
						stroke-linejoin="round"
						class="h-4 w-4 opacity-50"
						aria-hidden="true"
					>
						<path d="m6 9 6 6 6-6"></path>
					</svg>
				</button>

				<ul 
				id="options-list" 
				role="listbox" 
				aria-hidden="true" 
				style="display: none;"
				class="text-gray-300 z-10 bg-gray-800 border border-gray-700 rounded-md shadow-lg py-1 mt-1 text-base ring-1 ring-black ring-opacity-5 overflow-auto focus:outline-none sm:text-sm max-h-60"
				>
				</ul>
			 <script>
				function toggleOptionsList() {
					var optionsList = document.getElementById('options-list');
					optionsList.style.display = (optionsList.style.display === 'none') ? 'block' : 'none';
					var isExpanded = optionsList.style.display === 'block';
					document.querySelector('button[id="toggle-roots-list"]').setAttribute('aria-expanded', isExpanded);
					optionsList.setAttribute('aria-hidden', !isExpanded);
				}

				function selectOption(option) {
					document.querySelector('button[id="toggle-roots-list"]').textContent = option;
					toggleOptionsList();
					displayGraph(option)
				}
				</script>
				<button 
				class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2 w-full mt-2 text-gray-300 border-gray-500"
				onclick="displayGraph('root')"
				>
					Show All Roots
				</button>
			</div>
		</div>
		<div class="mt-4">
			<h3 class="text-xl font-semibold mb-2 text-blue-400">Search</h3>
			<div class="relative">
				<svg
					xmlns="http://www.w3.org/2000/svg"
					width="24"
					height="24"
					viewBox="0 0 24 24"
					fill="none"
					stroke="currentColor"
					stroke-width="2"
					stroke-linecap="round"
					stroke-linejoin="round"
					class=" absolute left-2.5 top-2.5 h-4 w-4 text-gray-500"
				>
					<circle cx="11" cy="11" r="8"></circle>
					<path d="m21 21-4.3-4.3"></path>
				</svg>
				<input
					type="search"
					class="flex h-10 rounded-md px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 w-full appearance-none pl-8 text-gray-300 bg-gray-800 border border-gray-700"
					placeholder="Search nodes or edges..."
				/>
			</div>
		</div>
	</div>
	<div class="flex-1 p-4 relative bg-gray-800">
		<h3 class="text-xl font-semibold mb-2 text-blue-400">Visualization</h3>
		<div class="w-full h-full rounded-lg border border-gray-700 border-dashed" id="holder">
		<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/jointjs/3.7.5/joint.css" />
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.4/jquery.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.4.1/backbone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jointjs/3.7.5/joint.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/elkjs@0.8.2/lib/elk.bundled.min.js "></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jointjs/3.7.7/vectorizer.min.js"></script>
		<script src="https://cdn.rawgit.com/ariutta/svg-pan-zoom/master/dist/svg-pan-zoom.min.js"></script>

		<script>
{{MD5}}
const baseGraph = {{GRAPH_DATA}}

async function renderGraph(treeGraph){
	treeGraph = JSON.parse(JSON.stringify(treeGraph));

	let elements = [];

	let id = 0;

	function getTextDimensions(text, font) {
      // Create a temporary canvas
      var canvas = document.createElement('canvas');
      var context = canvas.getContext('2d');

      // Set the font on the context
      context.font = font;

			//split text into lines and get the longest one
			let lines = text.split("\n");
			let longestLine = "";
			for(let i = 0; i < lines.length; i++){
				if(lines[i].length > longestLine.length){
					longestLine = lines[i];
				}
			}
      var width = context.measureText(longestLine).width;
				

      // Get the font metrics
      var metrics = context.measureText(text);
      var height = metrics.actualBoundingBoxAscent + metrics.actualBoundingBoxDescent;

      // Return the dimensions
      return { width: width, height: height };
    }


	function fillHashes(node){
		stringRep = JSON.stringify(node)
		md5 = MD5(stringRep)
		node.md5 = md5;
		if (node.deps) {
			node.deps.forEach(d => {
				fillHashes(d);
			});
		}
	}


	fillHashes(treeGraph)

	function fillSizes(node){
		const text = node.name + (node.value ? `\n(${node.value})` : '')
		// cut all lines so they are max 30 chars long
		const lines = text.split("\n");
		for(let i = 0; i < lines.length; i++){
			if(lines[i].length > 30){
				lines[i] = lines[i].substring(0, 30) + "...";
			}
		}
		cut = lines.join("\n");
		const {width, height} = getTextDimensions(cut, '14px DejaVu Sans');
		node.width = width + 20;
		node.height = height + 20;
		node.label = cut
		node.tooltip = text
		if (node.deps) {
			node.deps.forEach(d => {
				fillSizes(d);
			});
		}
	}

	fillSizes(treeGraph)

	seen = {}
	id2node = {}
	var graph = new joint.dia.Graph({}, { cellNamespace: namespace });

	const elk = new ELK();

	var g = {
		id: "root",
		layoutOptions: { 
			'elk.algorithm': 'layered',
			'elk.direction': 'DOWN',
		},
		children: [],
		edges: [],
	}

	function processDependency(dep, parentID=null) {
		seenNode = seen[dep.md5];
		if (seenNode) {
			if (parentID) {
				parent = id2node[parentID];
				if (parent) {
					g.edges.push({ id: `${id}`, sources: [ parent.id ], targets: [ seenNode.id ] })
				} else {
					console.log('no parent', parentID)
				}
			}
			return;
		}
		let myID = id;
		id++;

		dep.id = myID;
		seen[dep.md5] = dep;

		g.children.push({
			id: myID, 
			width: dep.width, 
			height: dep.height,
			label: dep.label,
			tooltip: dep.tooltip,
		})

		id2node[myID] = dep;

		if (parentID) {
			parent = id2node[parentID];
			if (parent) {
				g.edges.push({ id: `${id}`, sources: [ parentID ], targets: [ dep.id ] })
			} else {
				console.log('no parent', parentID)
			}
		}

		if (dep.deps) {
			dep.deps.forEach(d => {
				processDependency(d, myID);
			});
		}
	}

	processDependency(treeGraph);

	await elk.layout(g);

	function createJointGraph() {
		id2node = {}

		g.children.forEach(function(node) {
			rect = new joint.shapes.standard.Rectangle();
			id2node[node.id] = rect;
			rect.tooltip = node.tooltip;
			rect.resize(node.width, node.height);
			rect.position(node.x, node.y);
			rect.attr({
				body: {
					fill: '#051015',
				},
				label: {
					text: node.label,
					fill: '#d1d5db',
				}
			});
			rect.addTo(graph);
		});

		g.edges.forEach(function(e) {
			points = []
			if (e.sections) {
				e.sections.forEach(function(s) {
					points.push({ x: s.startPoint.x, y: s.startPoint.y });
					if (s.bendPoints)
						s.bendPoints.forEach(function(b) {
							points.push({ x: b.x, y: b.y });
						});
					points.push({ x: s.endPoint.x, y: s.endPoint.y });
				});
			}

			points.pop();

			link = new joint.shapes.standard.Link();
			const linkArgs =  {
				connectionPoint: {
					name: 'boundary',
					args: {
						sticky: true,
					}
				},
				anchor: {
					name: 'perpendicular',
					args: {
						padding: 10,
					}
				}
			}

			const target = id2node[e.targets[0]];

			link.source(id2node[e.sources[0]], linkArgs);
			link.target(target, linkArgs);
			link.vertices(points);
			link.attr('line/stroke', '#eab308');
			link.addTo(graph);
		});
	}

	createJointGraph();

	var namespace = joint.shapes;

	holder = document.getElementById('holder');

	var paper = new joint.dia.Paper({
		el: holder,
		model: graph,
		width: '100%',
		height: '96%',
		gridSize: 1,
		cellViewNamespace: namespace,
		//block dragging edges and nodes
		interactive: false
	});

  // Handle mousemove event for panning
  let isDragging = false;
  let dragStartX, dragStartY;
	//find svg in holder

	svg = holder.querySelector('svg');
	svg_id = svg.getAttribute('id');

	panAndZoom = svgPanZoom(`#${svg_id}`)

	//Enable pan when a blank area is click (held) on
	paper.on('blank:pointerdown', function (evt, x, y) {
		panAndZoom.enablePan();
	});

	//Disable pan when the mouse button is released
	paper.on('cell:pointerup blank:pointerup', function(cellView, event) {
		panAndZoom.disablePan();
	});
	paper.on('element:mouseenter', function(e) {
		highlight(e.model, graph);
		var tooltip = $('#tooltip');
		tooltip.text(e.model.tooltip);
		tooltip.css({
			top: event.clientY + 10,
			left: event.clientX + 10,
			}).show();
	});

	// Hide tooltip on mouseout
	paper.on('element:mouseleave', function(e) {
		unhighlight(e.model, graph);
		$('#tooltip').hide();
	});
}

function highlight(node, graph){
	//highlight node
	node.attr({
		body: {
			fill: '#eab308',
		},
		label: {
			fill: '#000000',
		}
	});

	//highlight all edges from this node
	graph.getConnectedLinks(node).forEach(function(link) {
		link.attr('line/stroke', '#ffffff');
	});
}

function unhighlight(node, graph){
	//unhighlight node
	node.attr({
		body: {
			fill: '#051015',
		},
		label: {
			fill: '#d1d5db',
		}
	});

	//unhighlight all edges from this node
	graph.getConnectedLinks(node).forEach(function(link) {
		link.attr('line/stroke', '#eab308');
	});
}

function displayGraph(root) {
	if (root === 'root') {
		renderGraph(baseGraph).catch(console.error);
		return;
	}
	const rootGraph = baseGraph.deps.find(d => d.name === root);
	renderGraph(rootGraph).catch(console.error);
}

roots = []
for (let dep of baseGraph.deps) {
	roots.push(dep.name);
}

function fillOptionsList(){
	const optionsList = document.getElementById('options-list');
	for(let i = 0; i < roots.length; i++){
		const option = document.createElement('li');
		option.setAttribute('role', 'option');
		option.textContent = roots[i];
		option.onclick = () => selectOption(roots[i]);
		optionsList.appendChild(option);
	}
}

fillOptionsList();

function fillParent(node, parent){
	if (parent) {
		node.parent = parent;
	}
	if (node.deps) {
		node.deps.forEach(d => {
			fillParent(d, node);
		});
	}
}
parentedTree = JSON.parse(JSON.stringify(baseGraph));

fillParent(parentedTree, null);
console.log(parentedTree);

renderGraph(baseGraph).catch(console.error);

</script>
		</div>
	</div>
</div>
<div id="tooltip" class="tooltip absolute bg-white p-2 border rounded shadow-md hidden">tooltip</div>
</body>
</html>
